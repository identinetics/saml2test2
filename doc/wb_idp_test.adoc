= How to run an IDP test with the web interface

Following roles is being used here:

- Test driver (TD): An embedded entity of the test tool. In the case of IDP-tests
  the TD is the SAML requester.
- Test target (TT): The entity that shall be tested. In the case of IDP-tests
  the TT is the SAML responder.

== Test Configuration

Configuration files are arranged in a hierarchy, with some files generated and others referenced. This documentation
assigns an ID to each file to be independent of the actual file name.

.Generic configuration independent of a specific test target
[cols="3", options="header"]
|===
|ID|Name in example|Contents
|TESTFLOWS|flows.yaml (or .json)|defines test flows and their order of execution
|===

.Base configuration for a specific test target
[cols="3", options="header"]
|===
|ID|Name in example|Contents
|TD-BASE-CONFIG|td_base_conf.py|pysaml2-style entity configuration for the test driver
|TD-COMBOS|td_combinations.yaml|defines combinations of the testdriver's base entity configuration to support tests depending on different metadata
|TT-METADATA|tt_metadata.xml|TT_METADATA|Metadata aggregate that needs to contain the test target's entityID (imported)
|===

.Generated configuration files
[cols="4", options="header"]
|===
|ID|Name in example|generated by|Contents
|TD-CONFIG-GEN|conf.py|build_sp_conf.py |List of test driver entities in pysaml2-style, permutation from TD-BASE-CONFIG and TD-VAR
|TD-METADATA|sps.xml|mk_multi_metadata.py|SAML EntityDescriptor for the test driver
|===

To generate TD-CONFIG-GEN run:

    build_sp_conf.py -b <TD-BASE-CONFIG> -i <TD-CONFIG> -o <>

.Configuration files passed on invocation
[cols="3", options="header"]
|=====
|ID|Name in example|Contents
|TOOL-CONFIG|wb/test_tool.yaml| test target entityID & metadata source, test flows and profile filter, template and static dirs
|TD-CONFIG-GEN|wb/conf.py| generated using build_sp_conf.py
|=====

== Command Line Usage

    idp_test.py [-r <JSON-FILE>] [-m] [-j] [-g <GITHUB-REPO>] -o <OUTPUTFILE> <CONFIG-DIR>

=== Examples

==== Server startup

    idp_test.py -g <GITHUB-REPO>
    idp_test.py -r <JSON-CONFIG-FILE>
    idp_test.py <CONFIG-DIR>

This commands starts the web server. Open the test interface on localhost:8087.

==== Generators

    Writing metadata: idp_test.py -m -o <OUTPUTFILE>
    Write config in json format: idp_test.py -j -o <OUTPUTFILE>

== Switching config

=== Userdefined configs

Users have only access to the web-interface and are able to override the config (partly, of course) with
their own configuration stored on github. Loading and switching to such a config is done by a GET request:

    <URL>/swconf?github=<GITHUB-REPO-NAME>&email=<USER-EMAIL>

Example:

    http://localhost:8087/swconf?github=myuser/saml2test2-github-config-repo&email=me@example.org

=== Restricting Users

Users ability to switch to another config by creating a yaml file, holding lines of the form

   <GITHUB-USERNAME>: <USER-EMAIL>

and defining the file in the config using:

   def config(self):
      ...
      self.ACCESS_CONTROL_FILE = '<FILENAME>'

== Graphical Overview

image::testtool-conf.png[test tool configuration - graphical overview]

